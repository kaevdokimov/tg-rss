---
- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è TG-RSS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  hosts: tg_rss_servers
  become: yes
  gather_facts: yes

  vars:
    # –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
    create_backups: true
    backup_retention_days: "{{ backup_retention_days | default(7) }}"

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ swap
    swap_file_size: "{{ swap_file_size | default('1G') }}"
    swap_file_path: "{{ swap_file_path | default('/swapfile') }}"

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Docker
    docker_daemon_config:
      storage-driver: "overlay2"
      log-driver: "json-file"
      log-opts:
        max-size: "10m"
        max-file: "3"
      default-ulimits:
        nofile:
          soft: 65536
          hard: 65536
      iptables: false
      bridge: "none"
      ip-masq: false
      userland-proxy: false

    # –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    sysctl_params:
      # Swap
      vm.swappiness: 60
      vm.vfs_cache_pressure: 50

      # Network
      net.core.somaxconn: 1024
      net.ipv4.tcp_tw_reuse: 1
      net.ipv4.ip_local_port_range: "1024 65535"

      # Memory
      vm.overcommit_memory: 1
      vm.overcommit_ratio: 50

      # Filesystem
      fs.file-max: 2097152

  pre_tasks:
    - name: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è apt locks
      shell: |
        set -e
        echo "üîì –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è apt locks..."

        # –ñ–¥–µ–º –º–∞–∫—Å–∏–º—É–º 5 –º–∏–Ω—É—Ç
        for i in {1..60}; do
          if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \
             ! fuser /var/lib/dpkg/lock >/dev/null 2>&1 && \
             ! fuser /var/cache/apt/archives/lock >/dev/null 2>&1; then
            echo "‚úÖ Apt locks —Å–≤–æ–±–æ–¥–Ω—ã"
            exit 0
          fi
          echo "‚è≥ –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è apt locks ($i/60)..."
          sleep 5
        done

        echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ apt –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
        killall apt apt-get dpkg || true
        sleep 2
        killall -9 apt apt-get dpkg || true
        sleep 2

        # –û—á–∏—â–∞–µ–º locks
        rm -f /var/lib/dpkg/lock-frontend
        rm -f /var/lib/dpkg/lock
        rm -f /var/cache/apt/archives/lock

        echo "‚úÖ Apt locks –æ—á–∏—â–µ–Ω—ã"
      args:
        executable: /bin/bash
      register: apt_lock_result
      failed_when: apt_lock_result.rc != 0 and "killall" not in apt_lock_result.stderr
      when: ansible_os_family == "Debian"
      rescue:
        - name: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å apt locks
          fail:
            msg: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å apt locks –ø–æ—Å–ª–µ 5 –º–∏–Ω—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è. –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏."

    - name: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Å–µ—Ä–≤–µ—Ä–∞
      block:
        - name: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ Docker —Å–µ—Ä–≤–∏—Å–æ–≤
          service:
            name: "{{ item }}"
            state: stopped
            enabled: false
          loop:
            - docker
            - docker.socket
            - containerd
          ignore_errors: true
          register: docker_stop_result

        - name: –£–¥–∞–ª–µ–Ω–∏–µ Docker –ø–∞–∫–µ—Ç–æ–≤
          apt:
            name:
              - docker
              - docker-engine
              - docker.io
              - containerd
              - runc
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: absent
            purge: true
          ignore_errors: true
          register: docker_purge_result

        - name: –û—á–∏—Å—Ç–∫–∞ Docker —Ñ–∞–π–ª–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /etc/apt/sources.list.d/docker*.list
            - /usr/share/keyrings/docker*.gpg
            - /etc/apt/trusted.gpg.d/docker*.gpg
            - /var/lib/docker
            - /etc/docker
          ignore_errors: true

        - name: –û—á–∏—Å—Ç–∫–∞ apt cache –¥–ª—è Docker
          shell: |
            apt-get clean
            apt-get autoclean
            rm -rf /var/lib/apt/lists/*docker*
          args:
            executable: /bin/bash
          ignore_errors: true

        - name: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏ Docker
          shell: |
            if command -v docker >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Docker –≤—Å–µ –µ—â–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              exit 1
            else
              echo "‚úÖ Docker –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω"
            fi
          args:
            executable: /bin/bash
          register: docker_check_result
          failed_when: docker_check_result.rc != 0

      rescue:
        - name: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –æ—á–∏—Å—Ç–∫–æ–π Docker
          debug:
            msg: "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å Docker. –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ."
      when: ansible_os_family == "Debian"

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ SSH —Å–µ—Ä–≤–∏—Å–∞
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ SSH —Å–µ—Ä–≤–∏—Å–∞
          service:
            name: ssh
            state: started
            enabled: true
          register: ssh_service_result

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ SSH –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          service:
            name: ssh
            state: restarted
          when: ssh_service_result.changed
      rescue:
        - name: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å SSH
          debug:
            msg: "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å SSH —Å–µ—Ä–≤–∏—Å. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç."
      when: ansible_os_family == "Debian"

    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_update_result
      retries: 3
      delay: 10
      until: apt_update_result is succeeded
      when: ansible_os_family == "Debian"

    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      apt:
        upgrade: dist
        update_cache: yes
        cache_valid_time: 3600
      register: apt_upgrade_result
      retries: 2
      delay: 30
      until: apt_upgrade_result is succeeded
      when: ansible_os_family == "Debian"

  roles:
    - role: system_optimization
      tags: ['system', 'optimization', 'always']
    - role: docker_setup
      tags: ['docker', 'containers', 'always']
    - role: monitoring_setup
      tags: ['monitoring', 'prometheus', 'grafana', 'alerting']
    - role: security_hardening
      tags: ['security', 'hardening', 'firewall', 'ssh']
    - role: backup_system
      tags: ['backup', 'monitoring']
