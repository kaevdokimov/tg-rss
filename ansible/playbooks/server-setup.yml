---
- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è TG-RSS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  hosts: tg_rss_servers
  become: yes
  gather_facts: yes

  vars:
    # –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
    create_backups: true
    backup_retention_days: 7

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ swap
    swap_file_size: "1G"
    swap_file_path: "/swapfile"

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Docker
    docker_daemon_config:
      storage-driver: "overlay2"
      log-driver: "json-file"
      log-opts:
        max-size: "10m"
        max-file: "3"
      default-ulimits:
        nofile:
          soft: 65536
          hard: 65536
      iptables: false
      bridge: "none"
      ip-masq: false
      userland-proxy: false

    # –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    sysctl_params:
      # Swap
      vm.swappiness: 60
      vm.vfs_cache_pressure: 50

      # Network
      net.core.somaxconn: 1024
      net.ipv4.tcp_tw_reuse: 1
      net.ipv4.ip_local_port_range: "1024 65535"

      # Memory
      vm.overcommit_memory: 1
      vm.overcommit_ratio: 50

      # Filesystem
      fs.file-max: 2097152

  pre_tasks:
    - name: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è apt locks
      shell: |
        set -e
        echo "üîì –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è apt locks..."

        # –ñ–¥–µ–º –º–∞–∫—Å–∏–º—É–º 5 –º–∏–Ω—É—Ç
        for i in {1..60}; do
          if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \
             ! fuser /var/lib/dpkg/lock >/dev/null 2>&1 && \
             ! fuser /var/cache/apt/archives/lock >/dev/null 2>&1; then
            echo "‚úÖ Apt locks —Å–≤–æ–±–æ–¥–Ω—ã"
            exit 0
          fi
          echo "‚è≥ –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è apt locks ($i/60)..."
          sleep 5
        done

        echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ apt –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
        killall apt apt-get dpkg || true
        sleep 2
        killall -9 apt apt-get dpkg || true
        sleep 2

        # –û—á–∏—â–∞–µ–º locks
        rm -f /var/lib/dpkg/lock-frontend
        rm -f /var/lib/dpkg/lock
        rm -f /var/cache/apt/archives/lock

        echo "‚úÖ Apt locks –æ—á–∏—â–µ–Ω—ã"
      args:
        executable: /bin/bash
      ignore_errors: true
      when: ansible_os_family == "Debian"

    - name: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Å–µ—Ä–≤–µ—Ä–∞
      shell: |
        set -e
        echo "üóëÔ∏è –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker..."

        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –≤—Å–µ Docker —Å–µ—Ä–≤–∏—Å—ã
        systemctl stop docker docker.socket containerd || true
        systemctl disable docker docker.socket containerd || true

        # –£–¥–∞–ª—è–µ–º –≤—Å–µ Docker –ø–∞–∫–µ—Ç—ã
        apt-get remove --purge -y docker docker-engine docker.io containerd runc \
          docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin || true

        # –£–¥–∞–ª—è–µ–º –≤—Å–µ Docker repository —Ñ–∞–π–ª—ã
        rm -f /etc/apt/sources.list.d/docker*.list
        rm -f /usr/share/keyrings/docker*.gpg
        rm -f /etc/apt/trusted.gpg.d/docker*.gpg

        # –û—á–∏—â–∞–µ–º apt cache
        apt-get clean
        apt-get autoclean
        rm -rf /var/lib/apt/lists/*docker*
        rm -rf /var/lib/docker
        rm -rf /etc/docker

        echo "‚úÖ Docker –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω"
      args:
        executable: /bin/bash
      ignore_errors: true
      when: ansible_os_family == "Debian"

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ SSH —Å–µ—Ä–≤–∏—Å–∞
      service:
        name: ssh
        state: restarted
      ignore_errors: true
      when: ansible_os_family == "Debian"

    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

  roles:
    - system_optimization
    - docker_setup
    - monitoring_setup
    - security_hardening
