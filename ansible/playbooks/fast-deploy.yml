---
- name: –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ TG-RSS —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  hosts: tg_rss_servers
  become: yes
  gather_facts: smart
  strategy: free  # Allow parallel execution across hosts

  vars:
    # Performance optimizations
    ansible_ssh_pipelining: true
    ansible_ssh_common_args: '-o ControlMaster=auto -o ControlPersist=300s -o StrictHostKeyChecking=no'

  pre_tasks:
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Ansible
      set_fact:
        ansible_ssh_retries: 3
        ansible_ssh_timeout: 30
      when: ansible_connection == "ssh"

  tasks:
    - name: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
      apt:
        update_cache: yes
        upgrade: safe
        autoremove: yes
        autoclean: yes
      async: 900  # 15 minutes timeout
      poll: 0
      register: apt_upgrade
      when: ansible_os_family == "Debian"

    - name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤
      async_status:
        jid: "{{ apt_upgrade.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 30
      delay: 30

    - name: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
      include_role:
        name: system_optimization
        apply:
          tags: ['optimization']
      when: job_result.finished

    - name: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Docker
      include_role:
        name: docker_setup
      async: 600
      poll: 0
      register: docker_setup_job

    - name: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      include_role:
        name: security_hardening
      async: 600
      poll: 0
      register: security_job

    - name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Docker –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      async_status:
        jid: "{{ docker_setup_job.ansible_job_id }}"
      register: docker_result
      until: docker_result.finished
      retries: 30
      delay: 20

    - name: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      async_status:
        jid: "{{ security_job.ansible_job_id }}"
      register: security_result
      until: security_result.finished
      retries: 30
      delay: 20

    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –±—ç–∫–∞–ø–æ–≤
      include_role:
        name: monitoring_setup
      when: docker_result.finished and security_result.finished

    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –±—ç–∫–∞–ø–æ–≤
      include_role:
        name: backup_system
      when: docker_result.finished

    - name: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
          service:
            name: "{{ item }}"
            state: started
          loop:
            - docker
            - prometheus
            - grafana-server
          ignore_errors: true
          register: service_check

        - name: –û—Ç—á–µ—Ç –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏
          debug:
            msg: |
              üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!

              –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {{ ansible_date_time.iso8601 }}
              –°–µ—Ä–≤–µ—Ä: {{ inventory_hostname }}

              –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:
              {% for result in service_check.results %}
              {{ result.item }}: {% if result.changed %}‚úÖ{% else %}‚ùå{% endif %}
              {% endfor %}

              –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
              - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: journalctl -u tg-rss-backup.timer --since "1 hour ago"
              - –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–µ—Ä–≤—ã–π –±—ç–∫–∞–ø: systemctl start tg-rss-backup.service
              - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: http://localhost:9090