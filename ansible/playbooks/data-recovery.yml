---
- name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –∏ Redis
  hosts: tg_rss_servers
  become: yes
  gather_facts: yes

  vars:
    backup_dir: "/opt/tg-rss/backups"
    recovery_timestamp: "{{ lookup('env', 'RECOVERY_TIMESTAMP') | default('latest') }}"

  tasks:
    - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –±—ç–∫–∞–ø–∞–º–∏
      stat:
        path: "{{ backup_dir }}"
      register: backup_dir_stat

    - name: –í—ã—Ö–æ–¥–∏–º –µ—Å–ª–∏ –±—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
      fail:
        msg: "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –±—ç–∫–∞–ø–∞–º–∏ {{ backup_dir }} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
      when: not backup_dir_stat.stat.exists

    - name: –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø
      shell: |
        if [ "{{ recovery_timestamp }}" = "latest" ]; then
          find {{ backup_dir }} -name "postgres_backup_*.tar.gz" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-
        else
          find {{ backup_dir }} -name "postgres_backup_{{ recovery_timestamp }}.tar.gz" -type f
        fi
      register: postgres_backup
      when: recovery_timestamp != "skip"

    - name: –ù–∞—Ö–æ–¥–∏–º –±—ç–∫–∞–ø Redis
      shell: |
        if [ "{{ recovery_timestamp }}" = "latest" ]; then
          find {{ backup_dir }} -name "redis_backup_*.tar.gz" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-
        else
          find {{ backup_dir }} -name "redis_backup_{{ recovery_timestamp }}.tar.gz" -type f
        fi
      register: redis_backup
      when: recovery_timestamp != "skip"

    - name: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      shell: |
        cd /opt/tg-rss
        docker compose down --remove-orphans || true
      ignore_errors: yes

    - name: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PostgreSQL –¥–∞–Ω–Ω—ã–µ
      block:
        - name: –°–æ–∑–¥–∞–µ–º volume –¥–ª—è PostgreSQL –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          shell: docker volume create db_data || true

        - name: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ PostgreSQL –∏–∑ –±—ç–∫–∞–ø–∞
          shell: |
            docker run --rm -v db_data:/data -v {{ backup_dir }}:/backup alpine sh -c "
              rm -rf /data/*
              cd /data
              tar xzf /backup/$(basename '{{ postgres_backup.stdout }}')
            "
          when: postgres_backup.stdout != ""

        - name: –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ PostgreSQL
          debug:
            msg: "‚úÖ PostgreSQL –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ {{ postgres_backup.stdout }}"
          when: postgres_backup.stdout != ""

      when: postgres_backup.stdout != ""

    - name: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Redis –¥–∞–Ω–Ω—ã–µ
      block:
        - name: –°–æ–∑–¥–∞–µ–º volume –¥–ª—è Redis –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          shell: docker volume create redis_data || true

        - name: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Redis –∏–∑ –±—ç–∫–∞–ø–∞
          shell: |
            docker run --rm -v redis_data:/data -v {{ backup_dir }}:/backup alpine sh -c "
              rm -rf /data/*
              cd /data
              tar xzf /backup/$(basename '{{ redis_backup.stdout }}')
            "
          when: redis_backup.stdout != ""

        - name: –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ Redis
          debug:
            msg: "‚úÖ Redis –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ {{ redis_backup.stdout }}"
          when: redis_backup.stdout != ""

      when: redis_backup.stdout != ""

    - name: –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
      shell: |
        cd /opt/tg-rss
        docker compose up -d db redis

    - name: –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL
      shell: |
        for i in {1..30}; do
          if docker exec db pg_isready -U postgres -d news_bot >/dev/null 2>&1; then
            echo "PostgreSQL –≥–æ—Ç–æ–≤"
            exit 0
          fi
          sleep 2
        done
        echo "PostgreSQL –Ω–µ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω"
        exit 1
      when: postgres_backup.stdout != ""

    - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
      shell: |
        if docker exec redis redis-cli ping | grep -q PONG; then
          echo "Redis –¥–æ—Å—Ç—É–ø–µ–Ω"
        else
          echo "Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          exit 1
        fi
      when: redis_backup.stdout != ""

    - name: –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
      debug:
        msg: |
          üéâ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
          PostgreSQL: {{ '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if postgres_backup.stdout != '' else '–Ω–µ –Ω–∞–π–¥–µ–Ω –±—ç–∫–∞–ø' }}
          Redis: {{ '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if redis_backup.stdout != '' else '–Ω–µ –Ω–∞–π–¥–µ–Ω –±—ç–∫–∞–ø' }}

    - name: –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
      shell: |
        cd /opt/tg-rss
        docker compose up -d
