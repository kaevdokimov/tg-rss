---
- name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
  hosts: tg_rss_servers
  become: yes
  gather_facts: yes

  vars:
    recovery_type: "{{ recovery_type | default('full') }}"  # full, services, docker, monitoring

  pre_tasks:
    - name: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
      assert:
        that:
          - recovery_type in ['full', 'services', 'docker', 'monitoring']
        fail_msg: "recovery_type –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑: full, services, docker, monitoring"

    - name: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          service:
            name: "{{ item }}"
            state: started
          loop:
            - ssh
            - systemd-journald
          register: service_status
          ignore_errors: true

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
          shell: df -h / | tail -1
          register: disk_space
          ignore_errors: true

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏
          shell: free -h
          register: memory_info
          ignore_errors: true

        - name: –û—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã
          debug:
            msg: |
              üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:
              –°–µ—Ä–≤–∏—Å—ã: {{ service_status.results | selectattr('changed', 'equalto', false) | list | length }}/{{ service_status.results | length }} –∑–∞–ø—É—â–µ–Ω—ã
              –î–∏—Å–∫: {{ disk_space.stdout | default('N/A') }}
              –ü–∞–º—è—Ç—å: {{ memory_info.stdout | default('N/A') }}

  tasks:
    - name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Docker
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Docker
          shell: docker info >/dev/null 2>&1
          register: docker_check
          ignore_errors: true

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker daemon –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          service:
            name: docker
            state: restarted
          when: docker_check.rc != 0

        - name: –û—á–∏—Å—Ç–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          shell: |
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker stop $$(docker ps -aq) || true
            # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker rm $$(docker ps -aq) || true
            # –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
            docker image prune -f || true
          ignore_errors: true
          when: docker_check.rc == 0

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è Docker
          shell: docker run --rm hello-world
          register: docker_test
          retries: 3
          delay: 5
          until: docker_test.rc == 0
          when: recovery_type in ['full', 'docker']

      rescue:
        - name: –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
          debug:
            msg: "üîÑ Docker —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ."
      when: recovery_type in ['full', 'docker']
      tags: ['recovery', 'docker']

    - name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
      block:
        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          service:
            name: "{{ item }}"
            state: restarted
            enabled: true
          loop:
            - systemd-journald
            - systemd-timesyncd
            - ssh
          ignore_errors: true
          register: service_restart

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
          shell: systemctl restart systemd-networkd || systemctl restart NetworkManager
          ignore_errors: true

        - name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ systemd
          shell: systemctl daemon-reload
          ignore_errors: true

      rescue:
        - name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          debug:
            msg: "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: {{ ansible_failed_result.msg | default('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') }}"
        - name: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
          debug:
            msg: "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –Ω–æ —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"
      when: recovery_type in ['full', 'services']
      tags: ['recovery', 'services']

    - name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Prometheus
          uri:
            url: http://localhost:9090/-/healthy
            method: GET
            status_code: 200
          register: prometheus_health
          ignore_errors: true

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Prometheus –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          service:
            name: prometheus
            state: restarted
          when: prometheus_health.status != 200

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Node Exporter
          uri:
            url: http://localhost:9100/metrics
            method: GET
            status_code: 200
          register: node_exporter_health
          ignore_errors: true

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Node Exporter –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          service:
            name: node-exporter
            state: restarted
          when: node_exporter_health.status != 200

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Grafana
          uri:
            url: http://localhost:3000/api/health
            method: GET
            status_code: 200
          register: grafana_health
          ignore_errors: true

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Grafana –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          service:
            name: grafana-server
            state: restarted
          when: grafana_health.status != 200

      rescue:
        - name: –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
          debug:
            msg: "üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: make deploy -- --tags monitoring"
      when: recovery_type in ['full', 'monitoring']
      tags: ['recovery', 'monitoring']

    - name: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
      block:
        - name: –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤
          shell: |
            journalctl --vacuum-time=7d
            find /var/log -name "*.log" -type f -exec truncate -s 0 {} \;
          ignore_errors: true

        - name: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          reboot:
            msg: "–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"
            connect_timeout: 5
            reboot_timeout: 300
            pre_reboot_delay: 0
            post_reboot_delay: 30
          when: ansible_uptime_seconds > 3600  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç > 1 —á–∞—Å–∞

      rescue:
        - name: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
          debug:
            msg: "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ: {{ ansible_failed_result.msg | default('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') }}"
        - name: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
          debug:
            msg: "‚ö†Ô∏è –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
      tags: ['recovery', 'cleanup']

  post_tasks:
    - name: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
      debug:
        msg: |
          üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω–æ!

          –¢–∏–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {{ recovery_type }}
          –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {{ ansible_date_time.iso8601 }}
          –°–µ—Ä–≤–µ—Ä: {{ inventory_hostname }}

          –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
          - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –æ—à–∏–±–∫–∏
          - –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ