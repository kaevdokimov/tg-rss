#!/bin/bash

# Скрипт мониторинга TG-RSS приложения
LOG_FILE="/opt/tg-rss/logs/monitor.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] Starting TG-RSS monitoring check" >> $LOG_FILE

# Проверка health check endpoint
HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health)
if [ "$HEALTH_STATUS" -ne 200 ]; then
    echo "[$TIMESTAMP] WARNING: Health check failed with status $HEALTH_STATUS" >> $LOG_FILE

    # Попытка перезапуска контейнеров
    echo "[$TIMESTAMP] Attempting to restart containers" >> $LOG_FILE
    cd /opt/tg-rss
    docker-compose restart >> $LOG_FILE 2>&1

    # Отправка уведомления (здесь можно добавить email или Telegram уведомление)
    echo "[$TIMESTAMP] Containers restarted due to health check failure" >> $LOG_FILE
else
    echo "[$TIMESTAMP] Health check passed" >> $LOG_FILE
fi

# Проверка использования ресурсов
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
if [ "$MEMORY_USAGE" -gt 90 ]; then
    echo "[$TIMESTAMP] WARNING: High memory usage: $MEMORY_USAGE%" >> $LOG_FILE
fi

DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    echo "[$TIMESTAMP] WARNING: High disk usage: $DISK_USAGE%" >> $LOG_FILE
fi

echo "[$TIMESTAMP] Monitoring check completed" >> $LOG_FILE
