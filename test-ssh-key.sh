#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SSH –∫–ª—é—á–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –≤ GitHub Secrets
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./test-ssh-key.sh /path/to/private/key

set -e

if [ $# -eq 0 ]; then
    echo "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ SSH –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É –∫–ª—é—á—É"
    echo "–ü—Ä–∏–º–µ—Ä: $0 ~/.ssh/id_ed25519"
    exit 1
fi

KEY_FILE="$1"

echo "üîê –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH –∫–ª—é—á: $KEY_FILE"
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$KEY_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –∫–ª—é—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: $KEY_FILE"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
PERMS=$(stat -c "%a" "$KEY_FILE" 2>/dev/null || stat -f "%A" "$KEY_FILE")
if [ "$PERMS" != "600" ]; then
    echo "‚ö†Ô∏è  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ 600 –Ω–∞ –∫–ª—é—á"
    echo "   chmod 600 $KEY_FILE"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞..."
KEY_FORMAT=$(head -1 "$KEY_FILE")

case "$KEY_FORMAT" in
    "-----BEGIN OPENSSH PRIVATE KEY-----")
        echo "‚úÖ –§–æ—Ä–º–∞—Ç: OpenSSH (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π)"
        ;;
    "-----BEGIN RSA PRIVATE KEY-----")
        echo "‚úÖ –§–æ—Ä–º–∞—Ç: RSA (—Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π)"
        ;;
    "-----BEGIN EC PRIVATE KEY-----")
        echo "‚úÖ –§–æ—Ä–º–∞—Ç: ECDSA"
        ;;
    "-----BEGIN PRIVATE KEY-----")
        echo "‚ö†Ô∏è  –§–æ—Ä–º–∞—Ç: PKCS#8 - –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è"
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞"
        echo "–ü–µ—Ä–≤—ã–π —Å—Ç—Ä–æ–∫–∏ —Ñ–∞–π–ª–∞:"
        head -3 "$KEY_FILE"
        exit 1
        ;;
esac

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–ª—é—á–∞
echo
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–ª—é—á–∞..."
if ssh-keygen -l -f "$KEY_FILE" >/dev/null 2>&1; then
    KEY_INFO=$(ssh-keygen -l -f "$KEY_FILE")
    echo "‚úÖ –ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω: $KEY_INFO"
else
    echo "‚ùå –ö–ª—é—á –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
echo
echo "üîë –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:"
if [ -f "${KEY_FILE}.pub" ]; then
    cat "${KEY_FILE}.pub"
else
    echo "‚ö†Ô∏è  –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω (${KEY_FILE}.pub)"
    echo "   –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –µ–≥–æ: ssh-keygen -y -f $KEY_FILE"
fi

echo
echo "üìã –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ GitHub Secrets:"
echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞:"
echo "   cat $KEY_FILE"
echo
echo "2. –í—Å—Ç–∞–≤—å—Ç–µ –≤ GitHub: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí SERVER_SSH_KEY"
echo
echo "3. –î–æ–±–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä:"
echo "   ssh-copy-id -i ${KEY_FILE}.pub user@server"
echo
echo "‚úÖ SSH –∫–ª—é—á –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"
