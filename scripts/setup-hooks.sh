#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Git hooks –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ conventional commits

set -e

HOOKS_DIR=".git/hooks"
PRE_COMMIT_HOOK="$HOOKS_DIR/pre-commit"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ –∫–æ—Ä–Ω—è git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git hooks –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ conventional commits..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é hooks –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$HOOKS_DIR"

# –°–æ–∑–¥–∞–µ–º pre-commit hook
cat > "$PRE_COMMIT_HOOK" << 'EOF'
#!/bin/bash

# Pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ conventional commits
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

# –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
COMMIT_MSG_FILE=$1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
if [ -z "$COMMIT_MSG_FILE" ]; then
    echo "‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏: —Ñ–∞–π–ª —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω (–≤–µ—Ä–æ—è—Ç–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è -m)"
    echo "üí° –î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ git commit –±–µ–∑ -m —Ñ–ª–∞–≥–∞"
    exit 0
fi

if [ ! -f "$COMMIT_MSG_FILE" ] || [ ! -r "$COMMIT_MSG_FILE" ]; then
    echo "‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏: —Ñ–∞–π–ª —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "üí° –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ -m —Ñ–ª–∞–≥–∞"
    exit 0
fi

# –ß–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
if ! commit_msg=$(head -1 "$COMMIT_MSG_FILE" 2>/dev/null); then
    echo "‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞"
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
if [ -z "$commit_msg" ]; then
    echo "‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏: —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ –ø—É—Å—Ç–æ–µ"
    exit 0
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞: \"$commit_msg\""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞: —Ç–∏–ø(–æ–±–ª–∞—Å—Ç—å): –æ–ø–∏—Å–∞–Ω–∏–µ
if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\([a-zA-Z0-9_-]+\))?: '; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞"
    echo "   –û–∂–∏–¥–∞–µ—Ç—Å—è: —Ç–∏–ø(–æ–±–ª–∞—Å—Ç—å): –æ–ø–∏—Å–∞–Ω–∏–µ"
    echo "   –ü—Ä–∏–º–µ—Ä—ã:"
    echo "   ‚Ä¢ feat(bot): –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É inline-–∫–Ω–æ–ø–æ–∫"
    echo "   ‚Ä¢ fix(db): –∏—Å–ø—Ä–∞–≤–∏—Ç—å —É—Ç–µ—á–∫—É null –±–∞–π—Ç–æ–≤"
    echo "   ‚Ä¢ perf(cache): —É—Å–∫–æ—Ä–∏—Ç—å –ø–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤"
    echo ""
    echo "üìñ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: https://github.com/kaevdokimov/tg-rss/blob/main/COMMIT_CONVENTION.md"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (–Ω–µ –±–æ–ª–µ–µ 72 —Å–∏–º–≤–æ–ª–æ–≤)
if [ ${#commit_msg} -gt 72 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–º–∏—Ç–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (${#commit_msg} —Å–∏–º–≤–æ–ª–æ–≤, –º–∞–∫—Å–∏–º—É–º 72)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ—á–∫–æ–π
if echo "$commit_msg" | grep -q '\.$'; then
    echo "‚ùå –û—à–∏–±–∫–∞: –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è —Ç–æ—á–∫–æ–π"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã
description=$(echo "$commit_msg" | sed 's/^[^(]*([^)]*): //' 2>/dev/null || echo "$commit_msg")
if [[ $description =~ ^[–ê-–ØA-Z] ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã"
    exit 1
fi

echo "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—é"
exit 0
EOF

# –î–µ–ª–∞–µ–º hook –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x "$PRE_COMMIT_HOOK"

echo "‚úÖ Pre-commit hook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìù –¢–µ–ø–µ—Ä—å –≤—Å–µ –∫–æ–º–º–∏—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"
echo "   —Å–æ–≥–ª–∞—à–µ–Ω–∏—é conventional commits."
echo ""
echo "üí° –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è hotfix):"
echo "   git commit --no-verify -m \"fix: –±—ã—Å—Ç—Ä–∞—è –ø—Ä–∞–≤–∫–∞\""
echo ""
echo "üìñ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: COMMIT_CONVENTION.md"
