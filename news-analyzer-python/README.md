# News Analyzer - Аналитический модуль "Карта дня"

Python-сервис для анализа новостей и группировки их в темы (кластеры).

## Описание

Модуль анализирует новости за последние 24 часа из базы данных PostgreSQL, группирует их в темы с помощью кластеризации HDBSCAN и формирует отчет о топ-5 нарративах дня.

## Требования

- Python 3.11+
- PostgreSQL (использует ту же БД, что и Go-проект)
- Доступ к таблице `news` в БД

## Установка

1. Создайте виртуальное окружение:
```bash
python3 -m venv venv
source venv/bin/activate  # для Linux/Mac
# или
venv\Scripts\activate  # для Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Скачайте данные NLTK (стоп-слова для русского языка):
```bash
python setup_nltk.py
```

4. Настройте конфигурацию:
```bash
cp env.example .env
cp config.yaml.example config.yaml
```

Отредактируйте `.env` и `config.yaml` согласно вашей конфигурации БД.

**Важно:** Убедитесь, что параметры подключения к БД в `.env` совпадают с параметрами вашего Go-проекта:
- `POSTGRES_HOST` - хост БД (обычно `db` для Docker или `localhost` для локальной разработки)
- `POSTGRES_PORT` - порт (обычно `5432`)
- `POSTGRES_USER` - пользователь БД
- `POSTGRES_PASSWORD` - пароль БД
- `POSTGRES_DB` - имя базы данных (обычно `news_bot`)

## Использование

### Тестирование подключения к БД

Перед первым запуском проверьте подключение:
```bash
python test_connection.py
```

Этот скрипт проверит:
- Подключение к PostgreSQL
- Наличие таблицы `news`
- Получение новостей за последние 24 часа

### Ручной запуск анализа

```bash
python run_daily.py
```

Скрипт выполнит:
1. Подключение к БД
2. Получение новостей за последние 24 часа
3. Предобработку текста
4. Векторизацию через TF-IDF
5. Кластеризацию через HDBSCAN
6. Построение нарративов (топ-5 тем)
7. Сохранение отчета в JSON

Результаты сохраняются в `storage/reports/report_YYYY-MM-DD.json`.

### Запуск через cron

Добавьте в crontab для ежедневного запуска в 00:00:
```bash
0 0 * * * cd /path/to/news-analyzer-python && /path/to/venv/bin/python run_daily.py >> /path/to/logs/cron.log 2>&1
```

## Структура проекта

```
news-analyzer-python/
├── src/
│   ├── config/          # Конфигурация
│   ├── db/              # Подключение к БД
│   ├── fetcher/         # Получение новостей
│   ├── preprocessor/    # Предобработка текста
│   ├── analyzer/        # Векторизация и кластеризация
│   ├── narrative/       # Построение нарративов
│   ├── reporter/        # Генерация отчетов
│   └── utils/           # Утилиты
├── storage/
│   ├── reports/         # JSON отчеты
│   └── logs/            # Логи
└── tests/               # Тесты
```

## Конфигурация

Основные параметры настраиваются в `config.yaml`:
- `time_window_hours`: окно анализа (по умолчанию 24 часа)
- `min_cluster_size`: минимальный размер кластера
- `top_narratives`: количество топ-тем в отчете

Параметры подключения к БД настраиваются в `.env`.

## Результаты

Отчеты сохраняются в `storage/reports/` в формате JSON с именем файла `report_YYYY-MM-DD.json`.

## Разработка

Проект спроектирован для легкого расширения. Каждый модуль отвечает за свою задачу:
- `fetcher`: получение данных из БД
- `preprocessor`: очистка и подготовка текста
- `analyzer`: векторизация и кластеризация
- `narrative`: извлечение ключевых слов и построение нарративов
- `reporter`: форматирование результатов
