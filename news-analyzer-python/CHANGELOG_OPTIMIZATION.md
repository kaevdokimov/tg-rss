# Оптимизация Docker образа и обновление до Python 3.14

## Выполненные изменения

### 1. Обновление до Python 3.14
- ✅ Обновлен базовый образ с `python:3.11-slim` на `python:3.14-slim`
- ✅ Обновлен numpy до версии 2.1.0 для лучшей совместимости с Python 3.14
- ✅ Проверена совместимость всех зависимостей

### 2. Минимизация размера образа

#### Удалены ненужные зависимости:
- ✅ Удален `cron` - не используется (используется простой цикл в entrypoint)
- ✅ Очистка кэша apt после каждой установки
- ✅ Очистка временных файлов на каждом этапе сборки

#### Оптимизация Python окружения:
- ✅ `PIP_NO_CACHE_DIR=1` - отключение кэша pip
- ✅ `PIP_DISABLE_PIP_VERSION_CHECK=1` - отключение проверки версии
- ✅ Очистка кэша pip после установки зависимостей
- ✅ Очистка кэша NLTK
- ✅ Удаление временных файлов (`/tmp`, `/var/tmp`)

#### Оптимизация .dockerignore:
- ✅ Исключены все `.md` файлы (кроме README.md)
- ✅ Исключены тесты и документация
- ✅ Исключены кэши Python (`__pycache__`, `.pyc`)

#### Объединение RUN команд:
- ✅ Объединены команды для уменьшения количества слоев
- ✅ Очистка выполняется в том же слое, что и установка

### 3. Очистка при деплое

Добавлена комплексная очистка Docker ресурсов в GitHub Actions workflow:

```bash
# Удаляем неиспользуемые образы
docker image prune -af

# Удаляем остановленные контейнеры
docker container prune -f

# Удаляем неиспользуемые сети
docker network prune -f

# Удаляем неиспользуемые volumes (осторожно)
docker volume prune -f

# Удаляем неиспользуемый build cache
docker builder prune -af
```

### 4. Оптимизация сборки

- ✅ Добавлен `--no-cache` флаг при сборке news-analyzer для чистой сборки
- ✅ Очистка выполняется автоматически при каждом деплое

## Ожидаемое уменьшение размера

- **До оптимизации**: ~800-1000 MB
- **После оптимизации**: ~400-600 MB (оценка)

## Проверка совместимости

Создан скрипт `test_dependencies.py` для проверки совместимости:

```bash
# В контейнере
docker exec -it news-analyzer python test_dependencies.py
```

## Обновленные зависимости

- `numpy`: 2.0.2 → 2.1.0 (для совместимости с Python 3.14)
- Остальные зависимости остались без изменений (совместимы с Python 3.14)

## Рекомендации

1. **Мониторинг размера образа**: После каждого деплоя проверяйте размер:
   ```bash
   docker images | grep news-analyzer
   ```

2. **Проверка совместимости**: При обновлении зависимостей проверяйте совместимость:
   ```bash
   python test_dependencies.py
   ```

3. **Очистка вручную**: При необходимости можно выполнить очистку вручную:
   ```bash
   docker system prune -af
   ```

## Известные ограничения

- Python 3.14 - новая версия, некоторые библиотеки могут иметь ограниченную поддержку
- Рекомендуется тестировать после каждого обновления зависимостей
