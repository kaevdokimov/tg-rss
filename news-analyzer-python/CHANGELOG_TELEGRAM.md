# Изменения: Отправка отчетов всем пользователям

## Обновления

### 1. Отправка всем подписанным пользователям
- ✅ Отчеты теперь отправляются **всем пользователям** из таблицы `users` в БД
- ✅ Каждый пользователь получает персональное сообщение с отчетом
- ✅ Статистика отправки: количество успешных и неудачных отправок

### 2. Использование отдельного бота
- ✅ Используется отдельный бот для отправки отчетов (не основной бот)
- ✅ Токен настраивается через GitHub Actions secrets (`TELEGRAM_API_KEY`)
- ✅ Поддержка локальной разработки через `.env`

### 3. Обработка ошибок
- ✅ Ошибки для отдельных пользователей не останавливают отправку другим
- ✅ Логирование заблокированных ботов (403 ошибка)
- ✅ Логирование некорректных chat_id (400 ошибка)
- ✅ Статистика успешных/неудачных отправок

### 4. Обновленные модули

#### `src/db/database.py`
- ✅ Добавлен класс `User` для представления пользователя
- ✅ Добавлен метод `get_all_users()` для получения всех пользователей из БД

#### `src/reporter/telegram_notifier.py`
- ✅ Обновлен `TelegramNotifier` - теперь не требует chat_id при инициализации
- ✅ Добавлен метод `send_message(chat_id, text)` для отправки конкретному пользователю
- ✅ Добавлен метод `send_message_to_all(chat_ids, text)` для массовой отправки
- ✅ Добавлен метод `send_report_to_all(chat_ids, report_path)` для отправки отчета всем

#### `run_daily.py`
- ✅ Обновлена логика отправки: получает всех пользователей из БД
- ✅ Отправляет отчет каждому пользователю
- ✅ Логирует статистику отправки

## Настройка

### GitHub Actions

Токен бота настраивается через GitHub Actions secrets:

1. Settings → Secrets and variables → Actions
2. Добавьте секрет `TELEGRAM_SIGNAL_API_KEY` с токеном бота для отчетов
3. При деплое токен автоматически передается в контейнер через `.env` файл

**Важно**: Это отдельная переменная от `TELEGRAM_API_KEY` (основной бот). Используется отдельный бот для отправки отчетов.

### Локальная разработка

Добавьте в `.env` (в корне проекта):
```env
TELEGRAM_SIGNAL_API_KEY=your_signal_bot_token_here
```

## Важные замечания

1. **Пользователи должны написать боту**: Бот может отправлять сообщения только тем пользователям, которые сначала написали ему `/start`

2. **Отдельный бот**: Рекомендуется использовать отдельного бота для отчетов, чтобы не мешать работе основного бота

3. **Обработка ошибок**: Если пользователь заблокировал бота, это логируется, но не влияет на отправку другим пользователям

## Пример логов

```
Получение списка пользователей из БД...
Найдено 47 пользователей. Отправка отчетов...
Отправка сообщения 47 пользователям...
Отправка завершена: успешно 45, ошибок 2
Не удалось отправить 2 пользователям: [123456789, 987654321]
```

## Тестирование

```bash
# Запустить анализ вручную
make analyzer-run

# Проверить логи
make analyzer-logs | grep -i telegram

# Проверить пользователей в БД
docker exec -it db psql -U postgres -d news_bot -c "SELECT COUNT(*) FROM users;"
```
