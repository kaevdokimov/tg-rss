# Оптимизация Docker образа

## Выполненные оптимизации

### 1. Минимизация размера образа

#### Удалены ненужные зависимости:
- ✅ Удален `cron` - не используется, вместо него простой цикл в entrypoint
- ✅ Очистка кэша apt после установки пакетов
- ✅ Очистка временных файлов на каждом этапе

#### Оптимизация Python:
- ✅ `PIP_NO_CACHE_DIR=1` - отключение кэша pip
- ✅ `PIP_DISABLE_PIP_VERSION_CHECK=1` - отключение проверки версии pip
- ✅ Очистка кэша pip после установки
- ✅ Удаление `__pycache__` и `.pyc` файлов
- ✅ Удаление документации Python (не нужна в runtime)

#### Оптимизация .dockerignore:
- ✅ Исключены все `.md` файлы (кроме README.md)
- ✅ Исключены тесты и документация
- ✅ Исключены кэши Python

### 2. Python 3.14

- ✅ Обновлен до Python 3.14-slim (последняя стабильная версия)
- ✅ Проверена совместимость зависимостей
- ✅ Обновлен numpy до 2.1.0 для лучшей совместимости

### 3. Очистка при деплое

Добавлена комплексная очистка Docker ресурсов в GitHub Actions workflow:

```bash
# Удаляем неиспользуемые образы
docker image prune -af

# Удаляем остановленные контейнеры
docker container prune -f

# Удаляем неиспользуемые сети
docker network prune -f

# Удаляем неиспользуемые volumes (осторожно)
docker volume prune -f

# Удаляем неиспользуемый build cache
docker builder prune -af
```

## Размер образа

Ожидаемый размер после оптимизации:
- **До оптимизации**: ~800-1000 MB
- **После оптимизации**: ~400-600 MB (оценка)

## Проверка размера образа

```bash
# После сборки проверить размер
docker images | grep news-analyzer

# Детальная информация
docker history news-analyzer
```

## Дополнительные рекомендации

### Для дальнейшей минимизации:

1. **Использовать distroless образ** (если не нужны системные утилиты):
   ```dockerfile
   FROM gcr.io/distroless/python3-debian12
   ```

2. **Многоэтапная сборка с удалением dev-зависимостей**:
   - Уже реализовано через multi-stage build

3. **Использовать .dockerignore**:
   - Уже настроен для исключения ненужных файлов

4. **Объединение RUN команд**:
   - Уже реализовано для уменьшения количества слоев

## Проверка совместимости

Для проверки совместимости зависимостей с Python 3.14:

```bash
# В контейнере
docker run -it --rm news-analyzer python -c "import pandas, numpy, sklearn, nltk, hdbscan, psycopg2; print('All imports successful')"
```

## Мониторинг размера

Рекомендуется отслеживать размер образа после каждого деплоя:

```bash
# В GitHub Actions можно добавить:
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep news-analyzer
```
