#!/bin/bash
# Backup rotation script for TG-RSS
# {{ ansible_managed }}

set -euo pipefail

# Configuration
BACKUP_DIR="{{ backup_base_dir }}"
RETENTION_DAYS="{{ backup_retention_days }}"
LOG_FILE="{{ backup_logs_dir }}/rotate-backups.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
    log "ERROR: $*"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*" >&2
    log "WARNING: $*"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*" >&2
    log "SUCCESS: $*"
}

log "Starting backup rotation (retention: ${RETENTION_DAYS} days)"

# Check if backup directory exists
if [ ! -d "$BACKUP_DIR" ]; then
    warning "Backup directory does not exist: $BACKUP_DIR"
    exit 0
fi

# Find backups older than retention period
OLD_BACKUPS=$(find "$BACKUP_DIR" -maxdepth 1 -type d -name "tg-rss-backup-*" -mtime +${RETENTION_DAYS} | sort)

if [ -z "$OLD_BACKUPS" ]; then
    log "No old backups to rotate"
    exit 0
fi

log "Found $(echo "$OLD_BACKUPS" | wc -l) old backups to remove"

# Calculate total size of backups to be removed
TOTAL_SIZE=$(echo "$OLD_BACKUPS" | xargs du -sh 2>/dev/null | awk '{sum += $1} END {print sum "MB"}' || echo "unknown")

# Remove old backups
echo "$OLD_BACKUPS" | while read -r backup; do
    if [ -n "$backup" ] && [ -d "$backup" ]; then
        BACKUP_SIZE=$(du -sh "$backup" | cut -f1)
        log "Removing backup: $(basename "$backup") ($BACKUP_SIZE)"
        rm -rf "$backup"
        success "Removed: $(basename "$backup")"
    fi
done

# Count remaining backups
REMAINING_BACKUPS=$(find "$BACKUP_DIR" -maxdepth 1 -type d -name "tg-rss-backup-*" | wc -l)
LATEST_BACKUP=$(find "$BACKUP_DIR" -maxdepth 1 -type d -name "tg-rss-backup-*" | sort | tail -1)
if [ -n "$LATEST_BACKUP" ]; then
    LATEST_SIZE=$(du -sh "$LATEST_BACKUP" | cut -f1)
    LATEST_DATE=$(stat -c %y "$LATEST_BACKUP" | cut -d'.' -f1)
    log "Latest backup: $(basename "$LATEST_BACKUP") ($LATEST_SIZE, $LATEST_DATE)"
fi

# Check disk usage
DISK_USAGE=$(df -h "$BACKUP_DIR" | tail -1 | awk '{print $5}')
log "Current disk usage: $DISK_USAGE"

success "Backup rotation completed"
log "Summary: removed ~$TOTAL_SIZE, $REMAINING_BACKUPS backups remaining"