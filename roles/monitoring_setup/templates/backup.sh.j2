#!/bin/bash

# Скрипт резервного копирования TG-RSS
BACKUP_DIR="/opt/tg-rss/backups"
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
BACKUP_NAME="tg-rss-backup-$TIMESTAMP"
LOG_FILE="/opt/tg-rss/logs/backup.log"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting backup: $BACKUP_NAME" >> $LOG_FILE

# Создание директории для бэкапа
mkdir -p "$BACKUP_DIR/$BACKUP_NAME"

# Остановка контейнеров перед бэкапом
cd /opt/tg-rss
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Stopping containers" >> $LOG_FILE
docker-compose stop >> $LOG_FILE 2>&1

# Бэкап Docker volumes
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Backing up Docker volumes" >> $LOG_FILE
docker run --rm -v tg-rss_db_data:/data -v "$BACKUP_DIR/$BACKUP_NAME:/backup" alpine tar czf /backup/db_data.tar.gz -C /data . >> $LOG_FILE 2>&1
docker run --rm -v tg-rss_redis_data:/data -v "$BACKUP_DIR/$BACKUP_NAME:/backup" alpine tar czf /backup/redis_data.tar.gz -C /data . >> $LOG_FILE 2>&1

# Бэкап конфигурационных файлов
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Backing up configuration files" >> $LOG_FILE
cp -r /opt/tg-rss/.env "$BACKUP_DIR/$BACKUP_NAME/" 2>> $LOG_FILE

# Запуск контейнеров после бэкапа
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting containers" >> $LOG_FILE
docker-compose start >> $LOG_FILE 2>&1

# Очистка старых бэкапов (оставляем последние 7)
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Cleaning old backups" >> $LOG_FILE
cd $BACKUP_DIR
ls -t | tail -n +8 | xargs -r rm -rf

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Backup completed: $BACKUP_NAME" >> $LOG_FILE
