# Enhanced Dependency Review with Security & License Checks
#
# Scans dependency changes in PRs for vulnerabilities, license issues, and security risks
# Blocks PRs with high/critical vulnerabilities or prohibited licenses

name: 'ðŸ”’ Security Dependency Review'
on:
  pull_request:
    branches: [ "main" ]
    paths:
      - 'go.mod'
      - 'go.sum'
      - 'news-analyzer-python/requirements.txt'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/*.yml'
      - 'ansible/requirements.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: 'Security & License Check'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v6

      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          # Block PRs with moderate or higher severity vulnerabilities
          fail-on-severity: moderate
          # Block problematic licenses
          deny-licenses: GPL-1.0-or-later, LGPL-2.0-or-later, MS-PL, BSD-4-Clause
          # Allow retries on snapshot warnings
          retry-on-snapshot-warnings: true
          # Show summary in PR comments
          comment-summary-in-pr: always
          # Additional vulnerability checks
          vulnerability-check: true
          # License compatibility check
          license-check: true

      - name: 'Security Scan Summary'
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerability Check**: âœ… Enabled (fail on moderate+)" >> $GITHUB_STEP_SUMMARY
          echo "- **License Check**: âœ… Enabled (blocks GPL/LGPL)" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Review**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Scanned Files:" >> $GITHUB_STEP_SUMMARY
          echo "- Go modules (go.mod, go.sum)" >> $GITHUB_STEP_SUMMARY
          echo "- Python requirements (requirements.txt)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker configurations" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Ansible requirements" >> $GITHUB_STEP_SUMMARY
        #   retry-on-snapshot-warnings: true
