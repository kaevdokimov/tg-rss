name: CI/CD Pipeline

permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-24.04

    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: go mod download
      
      # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      - name: Build application
        run: go build -ldflags='-s -w -extldflags "-static"' -o ./tg-rss-app
      
      # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Run tests
        run: go test ./... -v

  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-24.04
    needs: build
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –°–±–æ—Ä–∫–∞ –∏ –ø—É—à Docker-–æ–±—Ä–∞–∑–∞
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          no-cache: false
          tags: |
            ghcr.io/${{ github.repository_owner }}/news-bot:latest
            ghcr.io/${{ github.repository_owner }}/news-bot:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/news-bot:latest
          cache-to: type=inline

  docker-build-analyzer:
    name: Build and Push News Analyzer Image
    runs-on: ubuntu-24.04
    needs: build
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ news-analyzer
      - name: Build and Push News Analyzer Image
        uses: docker/build-push-action@v4
        with:
          context: ./news-analyzer-python
          file: ./news-analyzer-python/Dockerfile
          push: true
          no-cache: false
          tags: |
            ghcr.io/${{ github.repository_owner }}/news-analyzer:latest
            ghcr.io/${{ github.repository_owner }}/news-analyzer:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/news-analyzer:latest
          cache-to: type=inline

  server-setup:
    name: Server Infrastructure Setup
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[infra]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Run Ansible server setup
        run: |
          cd ansible
          mkdir -p inventory
          cat > inventory/hosts.ini << EOF
          [tg_rss_servers]
          ${{ secrets.SERVER_HOST }} ansible_host=${{ secrets.SERVER_HOST }} ansible_user=${{ secrets.SERVER_USER }} ansible_ssh_private_key_file=/home/runner/.ssh/id_rsa ansible_port=${{ secrets.SERVER_PORT || 22 }}
          EOF

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º inventory —Ñ–∞–π–ª
          echo "üìã Inventory —Ñ–∞–π–ª:"
          cat inventory/hosts.ini
          echo ""
          echo "üîë –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å –∫ SSH –∫–ª—é—á—É –≤ inventory:"
          grep "ansible_ssh_private_key_file" inventory/hosts.ini || echo "–ü—É—Ç—å –∫ –∫–ª—é—á—É –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ inventory"
          echo ""
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –∫–ª—é—á
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

          # –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          echo "üîó –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."
          ssh -i /home/runner/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo '‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" || exit 1

          # –ó–∞–ø—É—Å–∫–∞–µ–º ansible-playbook –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          echo "üîß –í–µ—Ä—Å–∏—è Ansible: $(ansible-playbook --version | head -1)"
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:"
          find playbooks/roles -name "system_optimization" -type d || echo "system_optimization not found in playbooks/roles"
          find ../roles -name "system_optimization" -type d || echo "system_optimization not found in ../roles"
          echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ Ansible:"
          echo "Inventory —Ñ–∞–π–ª:"
          cat inventory/hosts.ini
          echo ""
          echo "Ansible config:"
          cat ansible.cfg
          echo ""
          # –û—á–∏—â–∞–µ–º –∫—ç—à Ansible –∏ –∑–∞–ø—É—Å–∫–∞–µ–º playbook
          export ANSIBLE_CACHE_DIR=/tmp/ansible_cache
          rm -rf /tmp/ansible_cache
          echo "üîß –ó–∞–ø—É—Å–∫ Ansible —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏..."
          echo "üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π inventory: inventory/hosts.ini"
          ansible-playbook -i inventory/hosts.ini playbooks/server-setup.yml -v

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-24.04
    needs: [docker-build, docker-build-analyzer]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

      # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
      - name: Create .env file
        run: |
          cat > .env << 'EOL'
          # Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç)
          TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}
          # Telegram (–±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞)
          TELEGRAM_SIGNAL_API_KEY=${{ secrets.TELEGRAM_SIGNAL_API_KEY }}

          # PostgreSQL
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}


          # Application
          TZ=Europe/Moscow
          TIMEOUT=60

          # Content scraper configuration
          CONTENT_SCRAPER_INTERVAL=2
          CONTENT_SCRAPER_BATCH=20
          CONTENT_SCRAPER_CONCURRENT=6
          GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
          EOL

      # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SERVER_USER }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_PORT: ${{ secrets.SERVER_PORT || 22 }}
          DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/news-bot:latest
        run: |
          # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SSH –∫–ª—é—á–∞
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts || true

          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ
          cat > /tmp/.env << EOF
          # Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç)
          TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}
          # Telegram (–±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞)
          TELEGRAM_SIGNAL_API_KEY=${{ secrets.TELEGRAM_SIGNAL_API_KEY }}
          # PostgreSQL
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          # Application
          TZ=Europe/Moscow
          TIMEOUT=60
          GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}

          # Content scraper configuration
          CONTENT_SCRAPER_INTERVAL=2
          CONTENT_SCRAPER_BATCH=20
          CONTENT_SCRAPER_CONCURRENT=6
          EOF

          # –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry –ª–æ–∫–∞–ª—å–Ω–æ
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

          # –ö–æ–ø–∏—Ä—É–µ–º Docker config –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ registry
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p ~/.docker" || true
          scp -P $SSH_PORT ~/.docker/config.json $SSH_USER@$SSH_HOST:~/.docker/config.json || true

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p ~/news-bot" || true
          scp -P $SSH_PORT docker-compose.yml $SSH_USER@$SSH_HOST:~/news-bot/docker-compose.yml
          scp -P $SSH_PORT /tmp/.env $SSH_USER@$SSH_HOST:~/news-bot/.env

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "echo '‚úÖ SSH connection successful'"

          # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            set -a
            source ~/news-bot/.env
            set +a
            echo '‚úÖ Environment loaded'
          "

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker –∏ docker-compose
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            echo 'üîç Checking Docker installation...'
            if command -v docker >/dev/null 2>&1 && command -v docker-compose >/dev/null 2>&1; then
              echo '‚úÖ Docker and Docker Compose found'
            else
              echo '‚ùå Docker or Docker Compose not found'
              exit 1
            fi
          "

          # –û—Å–Ω–æ–≤–Ω–æ–π –¥–µ–ø–ª–æ–π
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            set -e
            echo 'üöÄ Starting deployment...'

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo 'üõë Stopping containers...'
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env down --remove-orphans || true

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—á–∏—â–∞–µ–º –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ volumes
            echo 'üîß Checking volumes integrity...'
            if docker volume ls | grep -q db_data; then
              echo 'üîç Checking PostgreSQL volume...'
              if ! docker run --rm -v db_data:/data alpine ls /data/base >/dev/null 2>&1; then
                echo '‚ö†Ô∏è PostgreSQL volume corrupted, recreating...'
                docker volume rm db_data
                docker volume create db_data
                echo '‚úÖ PostgreSQL volume recreated'
              else
                echo '‚úÖ PostgreSQL volume OK'
              fi
            fi

            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            echo '‚ñ∂Ô∏è Starting services...'
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env pull || true
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env up -d

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            echo '‚è≥ Waiting for services...'
            sleep 20

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo 'üìä Container status:'
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E '(bot|db|redis|news-analyzer)' || true

            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ PostgreSQL
            echo 'üîç PostgreSQL diagnostics:'
            if docker ps | grep -q db; then
              echo '‚úÖ PostgreSQL container exists'
              docker logs db --tail 10 || true
              echo 'Testing connection...'
              docker exec db pg_isready -U postgres 2>/dev/null && echo '‚úÖ Default postgres user works' || echo '‚ùå Default postgres user failed'
              docker exec db pg_isready -U \$POSTGRES_USER -d \$POSTGRES_DB 2>/dev/null && echo '‚úÖ Custom user works' || echo '‚ùå Custom user failed'
              docker exec db psql -U postgres -l 2>/dev/null | head -10 || echo '‚ùå Cannot list databases'
            else
              echo '‚ùå PostgreSQL container not found'
              docker logs db --tail 20 || true
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
            if docker ps | grep -q redis; then
              echo '‚úÖ Redis container running'
              docker exec redis redis-cli ping 2>/dev/null | grep -q PONG && echo '‚úÖ Redis ping OK' || echo '‚ö†Ô∏è Redis ping failed'
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º bot
            if docker ps | grep -q bot; then
              echo '‚úÖ Bot container running'
            else
              echo '‚ùå Bot container failed to start'
              docker logs bot --tail 20 || true
              exit 1
            fi

            echo '‚úÖ Deployment completed successfully!'
          "