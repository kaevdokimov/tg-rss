name: CI/CD Pipeline

permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-24.04

    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: go mod download
      
      # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      - name: Build application
        run: go build -ldflags='-s -w -extldflags "-static"' -o ./tg-rss-app
      
      # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Run tests
        run: go test ./... -v

  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-24.04
    needs: build
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –°–±–æ—Ä–∫–∞ –∏ –ø—É—à Docker-–æ–±—Ä–∞–∑–∞
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          no-cache: false
          tags: |
            ghcr.io/${{ github.repository_owner }}/news-bot:latest
            ghcr.io/${{ github.repository_owner }}/news-bot:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/news-bot:latest
          cache-to: type=inline

  docker-build-analyzer:
    name: Build and Push News Analyzer Image
    runs-on: ubuntu-24.04
    needs: build
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ news-analyzer
      - name: Build and Push News Analyzer Image
        uses: docker/build-push-action@v4
        with:
          context: ./news-analyzer-python
          file: ./news-analyzer-python/Dockerfile
          push: true
          no-cache: false
          tags: |
            ghcr.io/${{ github.repository_owner }}/news-analyzer:latest
            ghcr.io/${{ github.repository_owner }}/news-analyzer:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/news-analyzer:latest
          cache-to: type=inline

  server-setup:
    name: Server Infrastructure Setup
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[infra]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Run Ansible server setup
        run: |
          cd ansible
          mkdir -p inventory
          cat > inventory/hosts.ini << EOF
          [tg_rss_servers]
          ${{ secrets.SERVER_HOST }} ansible_host=${{ secrets.SERVER_HOST }} ansible_user=${{ secrets.SERVER_USER }} ansible_ssh_private_key_file=/tmp/ssh_key ansible_port=${{ secrets.SERVER_PORT || 22 }}
          EOF

          echo "${{ secrets.SERVER_SSH_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key

          # –ó–∞–ø—É—Å–∫–∞–µ–º ansible-playbook –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          echo "üîß –í–µ—Ä—Å–∏—è Ansible: $(ansible-playbook --version | head -1)"
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:"
          find playbooks/roles -name "system_optimization" -type d || echo "system_optimization not found in playbooks/roles"
          find ../roles -name "system_optimization" -type d || echo "system_optimization not found in ../roles"
          ansible-playbook -i inventory/hosts.ini playbooks/server-setup.yml -v

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-24.04
    needs: [docker-build, docker-build-analyzer]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

      # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
      - name: Create .env file
        run: |
          cat > .env << 'EOL'
          # Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç)
          TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}
          # Telegram (–±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞)
          TELEGRAM_SIGNAL_API_KEY=${{ secrets.TELEGRAM_SIGNAL_API_KEY }}
          
          # PostgreSQL
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST || 'localhost' }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT || '5432' }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          
          # Kafka
          KAFKA_BROKERS=${{ secrets.KAFKA_BROKERS || 'localhost:29092' }}
          KAFKA_NEWS_TOPIC=${{ secrets.KAFKA_NEWS_TOPIC || 'news-items' }}
          KAFKA_NOTIFY_TOPIC=${{ secrets.KAFKA_NOTIFY_TOPIC || 'news-notifications' }}
          
          # Application
          TZ=${{ secrets.TZ || 'Europe/Moscow' }}
          TIMEOUT=${{ secrets.TIMEOUT || '60' }}
          
          # Content scraper configuration
          CONTENT_SCRAPER_INTERVAL=${{ secrets.CONTENT_SCRAPER_INTERVAL || '2' }}
          CONTENT_SCRAPER_BATCH=${{ secrets.CONTENT_SCRAPER_BATCH || '20' }}
          CONTENT_SCRAPER_CONCURRENT=${{ secrets.CONTENT_SCRAPER_CONCURRENT || '6' }}
          EOL

      # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SERVER_USER }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_PORT: ${{ secrets.SERVER_PORT || 22 }}
          DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/news-bot:latest
        run: |
          # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SSH –∫–ª—é—á–∞
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts || true

          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ
          cat > /tmp/.env << EOF
          # Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç)
          TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}
          # Telegram (–±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞)
          TELEGRAM_SIGNAL_API_KEY=${{ secrets.TELEGRAM_SIGNAL_API_KEY }}
          # PostgreSQL
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          # Kafka
          KAFKA_BROKERS=kafka:29092
          KAFKA_NEWS_TOPIC=news-items
          KAFKA_NOTIFY_TOPIC=news-notifications
          # Application
          TZ=Europe/Moscow
          TIMEOUT=60
          GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
          
          # Content scraper configuration
          CONTENT_SCRAPER_INTERVAL=${{ secrets.CONTENT_SCRAPER_INTERVAL || '2' }}
          CONTENT_SCRAPER_BATCH=${{ secrets.CONTENT_SCRAPER_BATCH || '20' }}
          CONTENT_SCRAPER_CONCURRENT=${{ secrets.CONTENT_SCRAPER_CONCURRENT || '6' }}
          # GitHub repository owner –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ docker-compose.yml
          GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
          EOF

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p ~/news-bot" || true
          scp -P $SSH_PORT docker-compose.yml $SSH_USER@$SSH_HOST:~/news-bot/docker-compose.yml
          scp -P $SSH_PORT /tmp/.env $SSH_USER@$SSH_HOST:~/news-bot/.env

          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            set -e
            echo '‚úÖ SSH connection successful'

          # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
          echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
          # ANSIBLE_ROLES_PATH=roles ansible-playbook -i inventory/hosts.ini ansible/playbooks/app-config-update.yml || true

          # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–æ–ª–µ–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–æ–ª–µ–π..."
          ls -la ../roles/ | head -5 || echo "No roles in ../roles/"
          mkdir -p playbooks/roles
          cp -r ../roles/* playbooks/roles/ 2>/dev/null || echo "Roles copy failed or already in place"
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ playbooks/roles/:"
          ls -la playbooks/roles/ | head -10

            # üîí –ë–ï–ó–û–ü–ê–°–ù–´–ô –î–ï–ü–õ–û–ô: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ PostgreSQL –∏ Redis
            echo 'üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º...'
            mkdir -p ~/backups/pre-deploy
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            # –ë—ç–∫–∞–ø PostgreSQL volume –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if docker volume ls | grep -q db_data; then
              echo 'üì¶ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø PostgreSQL...'
              docker run --rm -v db_data:/data -v ~/backups/pre-deploy:/backup \
                alpine tar czf /backup/postgres_backup_$TIMESTAMP.tar.gz -C /data . || \
                echo '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø PostgreSQL'
            fi

            # –ë—ç–∫–∞–ø Redis volume –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if docker volume ls | grep -q redis_data; then
              echo 'üì¶ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø Redis...'
              docker run --rm -v redis_data:/data -v ~/backups/pre-deploy:/backup \
                alpine tar czf /backup/redis_backup_$TIMESTAMP.tar.gz -C /data . || \
                echo '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø Redis'
            fi

            echo 'üíæ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ volumes...'
            docker volume ls | grep -E '(db_data|redis_data)' || echo '‚ö†Ô∏è Volumes –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫'

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–ï–ó —É–¥–∞–ª–µ–Ω–∏—è volumes (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è!)
            echo 'üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (volumes —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)...'
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env down --remove-orphans || true

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - volumes –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è
            echo 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ volumes —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...'
            if docker volume ls | grep -q db_data; then
              echo '‚úÖ PostgreSQL volume –Ω–∞–π–¥–µ–Ω - –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏'
              DB_VOLUME_EXISTS=true
            else
              echo '‚ùå –ö–†–ò–¢–ò–ß–ù–ê–Ø –û–®–ò–ë–ö–ê: PostgreSQL volume –ø–æ—Ç–µ—Ä—è–Ω!'
              echo 'üîÑ –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞...'
              if [ -f ~/backups/pre-deploy/postgres_backup_$TIMESTAMP.tar.gz ]; then
                docker volume create db_data
                docker run --rm -v db_data:/data -v ~/backups/pre-deploy:/backup \
                  alpine sh -c "cd /data && tar xzf /backup/postgres_backup_$TIMESTAMP.tar.gz"
                echo '‚úÖ PostgreSQL –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –±—ç–∫–∞–ø–∞'
                DB_VOLUME_EXISTS=true
              else
                echo '‚ùå –ë—ç–∫–∞–ø –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å!'
                exit 1
              fi
            fi

            if docker volume ls | grep -q redis_data; then
              echo '‚úÖ Redis volume –Ω–∞–π–¥–µ–Ω'
            else
              echo '‚ö†Ô∏è Redis volume –Ω–µ –Ω–∞–π–¥–µ–Ω - –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∑–∞–Ω–æ–≤–æ'
            fi

            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –∏–∑ registry
            docker pull ghcr.io/${{ github.repository_owner }}/news-bot:latest || true
            docker pull ghcr.io/${{ github.repository_owner }}/news-analyzer:latest || true

            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ docker compose —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –æ–±—Ä–∞–∑–æ–≤
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env pull || true
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GITHUB_REPOSITORY_OWNER –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ docker-compose.yml
            export GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env up -d

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (zookeeper –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
            echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...'
            sleep 20
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo 'üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:'
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E '(bot|db|kafka|zookeeper|news-analyzer)' || true

            # üîí –ö–†–ò–¢–ò–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: PostgreSQL –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–ª–∏—Å—å
            echo 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL...'
            if docker ps | grep -q db; then
              echo '‚è≥ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL...'
              for i in {1..30}; do
                if docker exec db pg_isready -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} >/dev/null 2>&1; then
                  echo '‚úÖ PostgreSQL –≥–æ—Ç–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω'

                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–∞–∑–∞ –Ω–µ –ø—É—Å—Ç–∞—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
                  TABLES_COUNT=$(docker exec db psql -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null || echo "0")
                  if [ "$TABLES_COUNT" -gt 0 ]; then
                    echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $TABLES_COUNT —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ - –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"
                  else
                    echo '‚ÑπÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞ (–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)'
                  fi
                  break
                fi
                sleep 2
              done

              if [ $i -eq 30 ]; then
                echo '‚ùå PostgreSQL –Ω–µ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω –∑–∞ 60 —Å–µ–∫—É–Ω–¥'
                docker logs db --tail 20
                exit 1
              fi
            else
              echo '‚ùå PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!'
              docker logs db --tail 20 || true
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
            if docker ps | grep -q redis; then
              if docker exec redis redis-cli ping | grep -q PONG; then
                echo '‚úÖ Redis –¥–æ—Å—Ç—É–ø–µ–Ω'
              else
                echo '‚ö†Ô∏è Redis –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'
              fi
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            if ! docker ps | grep -q bot; then
              echo '‚ùå Bot –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!'
              docker logs bot --tail 20 || true
              exit 1
            fi

            echo '‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!'
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º news-analyzer (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è)
            if docker ps | grep -q news-analyzer; then
              echo '‚úÖ News analyzer –∑–∞–ø—É—â–µ–Ω'
            else
              echo '‚ö†Ô∏è News analyzer –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏:'
              docker logs news-analyzer --tail 50 || true
            fi

            # –û—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞ Docker
            echo 'üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker —Ä–µ—Å—É—Ä—Å–æ–≤...'
            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
            docker image prune -af || true
            # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker container prune -f || true
            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ç–∏
            docker network prune -f || true
            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ - –Ω–µ —É–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ)
            docker volume prune -f || true
            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ build cache
            docker builder prune -af || true
            echo '‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
          "