name: CI/CD Pipeline

permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-24.04

    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: go mod download
      
      # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      - name: Build application
        run: go build -ldflags='-s -w -extldflags "-static"' -o ./tg-rss-app
      
      # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Run tests
        run: go test ./... -v

  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-24.04
    needs: build
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –°–±–æ—Ä–∫–∞ –∏ –ø—É—à Docker-–æ–±—Ä–∞–∑–∞
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          no-cache: false
          tags: |
            ghcr.io/${{ github.repository_owner }}/news-bot:latest
            ghcr.io/${{ github.repository_owner }}/news-bot:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/news-bot:latest
          cache-to: type=inline

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-24.04
    needs: docker-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

      # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
      - name: Create .env file
        run: |
          cat > .env << 'EOL'
          # Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç)
          TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}
          # Telegram (–±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞)
          TELEGRAM_SIGNAL_API_KEY=${{ secrets.TELEGRAM_SIGNAL_API_KEY }}
          
          # PostgreSQL
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST || 'localhost' }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT || '5432' }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          
          # Kafka
          KAFKA_BROKERS=${{ secrets.KAFKA_BROKERS || 'localhost:29092' }}
          KAFKA_NEWS_TOPIC=${{ secrets.KAFKA_NEWS_TOPIC || 'news-items' }}
          KAFKA_NOTIFY_TOPIC=${{ secrets.KAFKA_NOTIFY_TOPIC || 'news-notifications' }}
          
          # Application
          TZ=${{ secrets.TZ || 'Europe/Moscow' }}
          TIMEOUT=${{ secrets.TIMEOUT || '60' }}
          
          # Content scraper configuration
          CONTENT_SCRAPER_INTERVAL=${{ secrets.CONTENT_SCRAPER_INTERVAL || '2' }}
          CONTENT_SCRAPER_BATCH=${{ secrets.CONTENT_SCRAPER_BATCH || '20' }}
          CONTENT_SCRAPER_CONCURRENT=${{ secrets.CONTENT_SCRAPER_CONCURRENT || '6' }}
          EOL

      # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SERVER_USER }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_PORT: ${{ secrets.SERVER_PORT || 22 }}
          DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/news-bot:latest
        run: |
          # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SSH –∫–ª—é—á–∞
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts || true

          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ
          cat > /tmp/.env << EOF
          # Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç)
          TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}
          # Telegram (–±–æ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞)
          TELEGRAM_SIGNAL_API_KEY=${{ secrets.TELEGRAM_SIGNAL_API_KEY }}
          # PostgreSQL
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          # Kafka
          KAFKA_BROKERS=kafka:29092
          KAFKA_NEWS_TOPIC=news-items
          KAFKA_NOTIFY_TOPIC=news-notifications
          # Application
          TZ=Europe/Moscow
          TIMEOUT=60
          GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
          
          # Content scraper configuration
          CONTENT_SCRAPER_INTERVAL=${{ secrets.CONTENT_SCRAPER_INTERVAL || '2' }}
          CONTENT_SCRAPER_BATCH=${{ secrets.CONTENT_SCRAPER_BATCH || '20' }}
          CONTENT_SCRAPER_CONCURRENT=${{ secrets.CONTENT_SCRAPER_CONCURRENT || '6' }}
          EOF

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p ~/news-bot" || true
          scp -P $SSH_PORT docker-compose.yml $SSH_USER@$SSH_HOST:~/news-bot/docker-compose.yml
          scp -P $SSH_PORT /tmp/.env $SSH_USER@$SSH_HOST:~/news-bot/.env
          
          # –ö–æ–ø–∏—Ä—É–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é news-analyzer-python –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p ~/news-bot/news-analyzer-python" || true
          scp -r -P $SSH_PORT news-analyzer-python/* $SSH_USER@$SSH_HOST:~/news-bot/news-analyzer-python/

          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            set -e
            echo '‚úÖ SSH connection successful'

            # –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–ï–ó —É–¥–∞–ª–µ–Ω–∏—è volumes (—á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ)
            # –§–ª–∞–≥ -v —É–¥–∞–ª—è–µ—Ç volumes, –ø–æ—ç—Ç–æ–º—É –µ–≥–æ —É–±–∏—Ä–∞–µ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env down --remove-orphans || true
            docker stop bot db kafka zookeeper news-analyzer 2>/dev/null || true
            docker rm bot db kafka zookeeper news-analyzer 2>/dev/null || true

            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑ –±–æ—Ç–∞
            docker pull ghcr.io/${{ github.repository_owner }}/news-bot:latest || true

            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ docker compose —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –æ–±—Ä–∞–∑–æ–≤
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env pull bot || true
            # –°–æ–±–∏—Ä–∞–µ–º news-analyzer (—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –∏–∑ registry)
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env build news-analyzer || true
            docker compose -f ~/news-bot/docker-compose.yml --env-file ~/news-bot/.env up -d

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (zookeeper –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
            echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...'
            sleep 20
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo 'üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:'
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E '(bot|db|kafka|zookeeper|news-analyzer)' || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ zookeeper –µ—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
            if ! docker ps | grep -q zookeeper; then
              echo '‚ö†Ô∏è Zookeeper –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏:'
              docker logs zookeeper --tail 50 || true
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E '(bot|db|kafka|zookeeper)' || exit 1
            echo '‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã'
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º news-analyzer (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è)
            if docker ps | grep -q news-analyzer; then
              echo '‚úÖ News analyzer –∑–∞–ø—É—â–µ–Ω'
            else
              echo '‚ö†Ô∏è News analyzer –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏:'
              docker logs news-analyzer --tail 50 || true
            fi

            # –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
            docker image prune -af
          "