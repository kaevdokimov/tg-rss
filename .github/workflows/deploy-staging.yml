name: Deploy to Staging

on:
  push:
    branches:
      - develop
      - staging
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BOT: ${{ github.repository }}/news-bot
  IMAGE_NAME_ANALYZER: ${{ github.repository }}/news-analyzer

jobs:
  test:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
        run: |
          go test -race -coverprofile=coverage.out -v ./...

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.out
          flags: unittests

  build-and-deploy:
    name: –°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π –≤ staging
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: –í—Ö–æ–¥ –≤ Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è news-bot
        id: meta-bot
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BOT }}
          tags: |
            type=ref,event=branch,suffix=-staging
            type=sha,prefix=staging-

      - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è news-analyzer
        id: meta-analyzer
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_ANALYZER }}
          tags: |
            type=ref,event=branch,suffix=-staging
            type=sha,prefix=staging-

      - name: –°–±–æ—Ä–∫–∞ –∏ push news-bot –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta-bot.outputs.tags }}
          labels: ${{ steps.meta-bot.outputs.labels }}

      - name: –°–±–æ—Ä–∫–∞ –∏ push news-analyzer –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v6
        with:
          context: ./news-analyzer-python
          file: ./news-analyzer-python/Dockerfile
          push: true
          tags: ${{ steps.meta-analyzer.outputs.tags }}
          labels: ${{ steps.meta-analyzer.outputs.labels }}

      - name: –î–µ–ø–ª–æ–π –≤ staging —á–µ—Ä–µ–∑ SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /opt/tg-rss-staging
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            git fetch origin
            git checkout staging
            git pull origin staging
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BOT }}:staging-${{ github.sha }}
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_ANALYZER }}:staging-${{ github.sha }}
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose —Å –Ω–æ–≤—ã–º–∏ —Ç–µ–≥–∞–º–∏
            export BOT_IMAGE_TAG=staging-${{ github.sha }}
            export ANALYZER_IMAGE_TAG=staging-${{ github.sha }}
            
            # Graceful restart
            docker-compose up -d --no-deps news-bot news-analyzer
            
            # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
            sleep 10
            
            echo "–î–µ–ø–ª–æ–π –≤ staging –∑–∞–≤–µ—Ä—à–µ–Ω"

  smoke-tests:
    name: Smoke tests –≤ staging
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Health check
        run: |
          max_attempts=6
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "–ü–æ–ø—ã—Ç–∫–∞ $attempt –∏–∑ $max_attempts..."
            
            if curl -f -s "http://${{ secrets.STAGING_HOST }}:8080/health"; then
              echo "Health check —É—Å–ø–µ—à–µ–Ω"
              exit 0
            fi
            
            echo "Health check –Ω–µ –ø—Ä–æ—à–µ–ª, –æ–∂–∏–¥–∞–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
          echo "Health check –Ω–µ –ø—Ä–æ—à–µ–ª –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
          exit 1

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ metrics endpoint
        run: |
          curl -f -s "http://${{ secrets.STAGING_HOST }}:8080/metrics" | grep "rss_polls_total"

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
          curl -f -s "http://${{ secrets.STAGING_HOST }}:8080/api/v1/sources" | jq '.success'

      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ –î–µ–ø–ª–æ–π –≤ staging —É—Å–ø–µ—à–µ–Ω
            
            üì¶ –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            
            –í—Å–µ smoke tests –ø—Ä–æ–π–¥–µ–Ω—ã.

      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå –î–µ–ø–ª–æ–π –≤ staging –Ω–µ —É–¥–∞–ª—Å—è
            
            üì¶ –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
