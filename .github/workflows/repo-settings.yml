# Branch Protection Management
# Applies branch protection rules using GitHub CLI

name: "ðŸ›¡ï¸ Branch Protection"

on:
  push:
    branches: [ "main" ]
    paths:
      - '.github/settings.yml'
      - '.github/workflows/repo-settings.yml'
  workflow_dispatch:

permissions:
  contents: read
  administration: write

jobs:
  branch-protection:
    name: 'Configure Branch Protection'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Configure branch protection for main
        run: |
          echo "Configuring branch protection for main branch..."

          # Create JSON payload for branch protection
          cat > branch_protection.json << 'EOF'
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["test", "lint", "security-scan"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true,
              "require_code_owner_reviews": false
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false
          }
          EOF

          # Apply branch protection
          gh api repos/${{ github.repository }}/branches/main/protection \
            --method PUT \
            --input branch_protection.json \
            --header "Accept: application/vnd.github+json" \
            --header "X-GitHub-Api-Version: 2022-11-28"

          echo "âœ… Branch protection configured for main branch"

      - name: Configure branch protection for develop (if exists)
        run: |
          # Check if develop branch exists
          if gh api repos/${{ github.repository }}/branches/develop --silent 2>/dev/null; then
            echo "Configuring branch protection for develop branch..."

            # Create JSON payload for develop branch protection
            cat > develop_protection.json << 'EOF'
            {
              "required_status_checks": {
                "strict": false,
                "contexts": ["test"]
              },
              "enforce_admins": false,
              "required_pull_request_reviews": {
                "required_approving_review_count": 1,
                "dismiss_stale_reviews": true,
                "require_code_owner_reviews": false
              },
              "restrictions": null,
              "allow_force_pushes": false,
              "allow_deletions": false,
              "block_creations": false
            }
            EOF

            # Apply branch protection for develop
            gh api repos/${{ github.repository }}/branches/develop/protection \
              --method PUT \
              --input develop_protection.json \
              --header "Accept: application/vnd.github+json" \
              --header "X-GitHub-Api-Version: 2022-11-28"

            echo "âœ… Branch protection configured for develop branch"
          else
            echo "â„¹ï¸ Develop branch does not exist, skipping"
          fi