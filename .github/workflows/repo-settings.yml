# Branch Protection Management
# Applies branch protection rules using GitHub CLI

name: "ðŸ›¡ï¸ Branch Protection"

on:
  push:
    branches: [ "main" ]
    paths:
      - '.github/settings.yml'
      - '.github/workflows/repo-settings.yml'
  workflow_dispatch:

# IMPORTANT: This workflow requires admin permissions
# To enable branch protection, you need to:
# 1. Go to repository Settings > Actions > General
# 2. Under "Workflow permissions", select "Read and write permissions"
# 3. Save the changes
# Or manually set branch protection in: Settings > Branches > Branch protection rules

jobs:
  branch-protection:
    name: 'Configure Branch Protection'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Check current branch protection status
        run: |
          echo "Checking current branch protection status for main..."

          # Check if branch protection exists
          PROTECTION_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/branches/main/protection")

          if [ "$PROTECTION_STATUS" = "200" ]; then
            echo "âœ… Branch protection already exists for main branch"
            exit 0
          elif [ "$PROTECTION_STATUS" = "404" ]; then
            echo "â„¹ï¸ Branch protection not found, configuring..."
          else
            echo "âŒ Error checking branch protection: HTTP $PROTECTION_STATUS"
            exit 1
          fi

      - name: Configure branch protection for main
        run: |
          echo "Configuring branch protection for main branch..."

          # Create JSON payload for branch protection
          cat > branch_protection.json << 'EOF'
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["test", "lint", "security-scan"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true,
              "require_code_owner_reviews": false
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false
          }
          EOF

          # Apply branch protection using curl with proper authentication
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d @branch_protection.json \
            "https://api.github.com/repos/${{ github.repository }}/branches/main/protection")

          HTTP_CODE=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Branch protection successfully configured for main branch"
          else
            echo "âŒ Failed to configure branch protection: HTTP $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Configure branch protection for develop (if exists)
        run: |
          # Check if develop branch exists
          if gh api repos/${{ github.repository }}/branches/develop --silent 2>/dev/null; then
            echo "Configuring branch protection for develop branch..."

            # Create JSON payload for develop branch protection
            cat > develop_protection.json << 'EOF'
            {
              "required_status_checks": {
                "strict": false,
                "contexts": ["test"]
              },
              "enforce_admins": false,
              "required_pull_request_reviews": {
                "required_approving_review_count": 1,
                "dismiss_stale_reviews": true,
                "require_code_owner_reviews": false
              },
              "restrictions": null,
              "allow_force_pushes": false,
              "allow_deletions": false,
              "block_creations": false
            }
            EOF

            # Apply branch protection for develop
            gh api repos/${{ github.repository }}/branches/develop/protection \
              --method PUT \
              --input develop_protection.json \
              --header "Accept: application/vnd.github+json" \
              --header "X-GitHub-Api-Version: 2022-11-28"

            echo "âœ… Branch protection configured for develop branch"
          else
            echo "â„¹ï¸ Develop branch does not exist, skipping"
          fi