# Notifications & Alerts System
# Telegram Bot integration for CI/CD events, failures, and deployments

name: "ðŸ“¢ Telegram Notifications"

on:
  workflow_run:
    workflows:
      - "CI/CD Pipeline"
      - "Go Extended CI"
      - "ðŸ” CodeQL Advanced Security"
      - "ðŸ›¡ï¸ Security Pipeline"
      - "ðŸ”’ Security Dependency Review"
    types:
      - completed
      - requested  # For manual workflow runs
  schedule:
    # Daily status report at 8 AM UTC
    - cron: '0 8 * * *'

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  notify:
    name: 'Send Notifications'
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate notification message
        id: notification
        run: |
          # Determine notification type and content
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          ACTOR="${{ github.event.workflow_run.triggering_actor.login }}"
          REPO_URL="https://github.com/$REPO"

          # Set status emoji and text
          case $CONCLUSION in
            "success")
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="SUCCESS"
              ;;
            "failure")
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="FAILURE"
              ;;
            "cancelled")
              STATUS_EMOJI="âš ï¸"
              STATUS_TEXT="CANCELLED"
              ;;
            *)
              STATUS_EMOJI="â“"
              STATUS_TEXT="$CONCLUSION"
              ;;
          esac

          # Create Telegram message with MarkdownV2 formatting
          # First escape the variables that contain special characters
          ESCAPED_WORKFLOW_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')
          ESCAPED_REPO=$(echo "$REPO" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')
          ESCAPED_BRANCH=$(echo "$BRANCH" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')
          ESCAPED_ACTOR=$(echo "$ACTOR" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')

          # Create message using cat and sed to avoid YAML parsing issues
          TELEGRAM_MESSAGE=$(cat << EOF | sed "s|{{STATUS_EMOJI}}|$STATUS_EMOJI|g; s|{{STATUS_TEXT}}|$STATUS_TEXT|g; s|{{WORKFLOW}}|$ESCAPED_WORKFLOW_NAME|g; s|{{REPO}}|$ESCAPED_REPO|g; s|{{REPO_RAW}}|$REPO|g; s|{{BRANCH}}|$ESCAPED_BRANCH|g; s|{{ACTOR}}|$ESCAPED_ACTOR|g; s|{{RUN_ID}}|$RUN_ID|g; s|{{DATE}}|$(date '+%Y-%m-%d %H:%M:%S UTC')|g"
{{STATUS_EMOJI}} *CI/CD {{STATUS_TEXT}}*

ðŸ—ï¸ *Workflow:* \`{{WORKFLOW}}\`
ðŸ“¦ *Repository:* [{{REPO}}](https://github.com/{{REPO_RAW}})
ðŸŒ¿ *Branch:* \`{{BRANCH}}\`
ðŸ‘¤ *Triggered by:* \`{{ACTOR}}\`
ðŸ”— *Details:* [View Run](https://github.com/{{REPO_RAW}}/actions/runs/{{RUN_ID}})

ðŸ• {{DATE}}
EOF
)

          echo "telegram_message<<EOF" >> $GITHUB_OUTPUT
          echo "$TELEGRAM_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "status=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "workflow=$WORKFLOW_NAME" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        if: env.GH_NOTIFY_TELEGRAM_BOT_TOKEN != '' && env.GH_NOTIFY_TELEGRAM_CHAT_ID != ''
        run: |
          # Send message to Telegram bot
          # Create JSON payload with proper escaping
          JSON_PAYLOAD=$(cat <<EOF
          {
            "chat_id": "${{ secrets.GH_NOTIFY_TELEGRAM_CHAT_ID }}",
            "text": "${{ steps.notification.outputs.telegram_message }}",
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }
          EOF
          )

          curl -X POST "https://api.telegram.org/bot${{ secrets.GH_NOTIFY_TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$JSON_PAYLOAD"

      - name: Log failure details
        if: github.event.workflow_run.conclusion == 'failure'
        run: |
          echo "Workflow failed: ${{ github.event.workflow_run.name }}"
          echo "See: https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

  # Daily status report
  daily-report:
    name: 'Daily Status Report'
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 8 * * *'
    steps:
      - name: Generate daily report
        run: |
          # Get workflow run statistics from the last 24 hours
          echo "## ðŸ“Š Daily CI/CD Status Report" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # This is a simplified report - in production you'd query GitHub API
          echo "### ðŸ”„ Recent Workflow Runs" >> $GITHUB_STEP_SUMMARY
          echo "- **Main Branch:** Check recent runs in Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scans:** CodeQL, SAST, Container scans" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Updates:** Dependabot PRs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ˆ Health Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Success Rate:** Monitor via Actions" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Coverage:** Check codecov reports" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Issues:** Check Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸŽ¯ Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review failed workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Check security advisories" >> $GITHUB_STEP_SUMMARY
          echo "- Review Dependabot PRs" >> $GITHUB_STEP_SUMMARY

      - name: Send daily report to Telegram
        if: env.GH_NOTIFY_TELEGRAM_BOT_TOKEN != '' && env.GH_NOTIFY_TELEGRAM_CHAT_ID != ''
        run: |
          # Create daily report message with proper escaping
          REPO_NAME="${{ github.repository }}"
          ESCAPED_REPO=$(echo "$REPO_NAME" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')

          # Create report message using cat and sed to avoid YAML issues
          REPORT_MESSAGE=$(cat << EOF | sed "s|{{DATE}}|$(date -u '+%Y-%m-%d')|g; s|{{REPO}}|$ESCAPED_REPO|g; s|{{SERVER_URL}}|${{ github.server_url }}|g; s|{{REPOSITORY}}|${{ github.repository }}|g; s|{{RUN_ID}}|${{ github.run_id }}|g"
ðŸ“Š *Daily CI/CD Status Report*
ðŸ“… {{DATE}}

*Repository:* {{REPO}}

ðŸ”„ *Recent Workflow Runs:*
â€¢ Main Branch: Check Actions tab
â€¢ Security Scans: CodeQL, SAST, Container
â€¢ Dependency Updates: Dependabot PRs

ðŸ“ˆ *Health Metrics:*
â€¢ Build Success Rate: Monitor via Actions
â€¢ Test Coverage: Check Codecov reports
â€¢ Security Issues: Check Security tab

ðŸŽ¯ *Recommendations:*
â€¢ Review failed workflows
â€¢ Check security advisories
â€¢ Review Dependabot PRs

ðŸ”— [View Report]({{SERVER_URL}}/{{REPOSITORY}}/actions/runs/{{RUN_ID}})
EOF
)

          # Send to Telegram
          curl -X POST "https://api.telegram.org/bot${{ secrets.GH_NOTIFY_TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${{ secrets.GH_NOTIFY_TELEGRAM_CHAT_ID }}\",
              \"text\": \"$REPORT_MESSAGE\",
              \"parse_mode\": \"MarkdownV2\",
              \"disable_web_page_preview\": true
            }"
