# Notifications & Alerts System
# Telegram Bot integration for CI/CD events, failures, and deployments

name: "üì¢ Telegram Notifications"

on:
  workflow_run:
    workflows:
      - "CI/CD Pipeline"
      - "Go Extended CI"
      - "üîç CodeQL Advanced Security"
      - "üõ°Ô∏è Security Pipeline"
      - "üîí Security Dependency Review"
    types:
      - completed
      - requested  # For manual workflow runs
  schedule:
    # Daily status report at 8 AM UTC
    - cron: '0 8 * * *'

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  notify:
    name: 'Send Notifications'
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate notification message
        id: notification
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          ACTOR: ${{ github.event.workflow_run.triggering_actor.login }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          REPO_URL="https://github.com/$REPO"

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–º–æ–¥–∑–∏ –∏ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
          case $CONCLUSION in
            "success")
              STATUS_EMOJI="‚úÖ"
              STATUS_TEXT="–£–°–ü–ï–•"
              ;;
            "failure")
              STATUS_EMOJI="‚ùå"
              STATUS_TEXT="–ù–ï–£–î–ê–ß–ê"
              ;;
            "cancelled")
              STATUS_EMOJI="‚ö†Ô∏è"
              STATUS_TEXT="–û–¢–ú–ï–ù–ï–ù–û"
              ;;
            *)
              STATUS_EMOJI="‚ùì"
              STATUS_TEXT="$CONCLUSION"
              ;;
          esac

          # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ Telegram —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º MarkdownV2
          # –°–Ω–∞—á–∞–ª–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
          ESCAPED_WORKFLOW_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')
          ESCAPED_REPO=$(echo "$REPO" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')
          ESCAPED_BRANCH=$(echo "$BRANCH" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')
          ESCAPED_ACTOR=$(echo "$ACTOR" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')

          # –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å YAML
          LINE1="$STATUS_EMOJI *CI/CD $STATUS_TEXT*"
          LINE2="üèóÔ∏è *–†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å:* \`$ESCAPED_WORKFLOW_NAME\`"
          LINE3="üì¶ *–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:* [$ESCAPED_REPO](https://github.com/$REPO)"
          LINE4="üåø *–í–µ—Ç–∫–∞:* \`$ESCAPED_BRANCH\`"
          LINE5="üë§ *–ó–∞–ø—É—â–µ–Ω–æ:* \`$ESCAPED_ACTOR\`"
          LINE6="üîó *–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:* [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—É—Å–∫](https://github.com/$REPO/actions/runs/$RUN_ID)"
          LINE7="üïê $(date '+%Y-%m-%d %H:%M:%S UTC')"

          # Combine into final message using printf
          TELEGRAM_MESSAGE=$(printf '%s\n\n%s\n%s\n%s\n%s\n%s\n\n%s' \
            "$LINE1" \
            "$LINE2" \
            "$LINE3" \
            "$LINE4" \
            "$LINE5" \
            "$LINE6" \
            "$LINE7")

          echo "telegram_message<<EOF" >> $GITHUB_OUTPUT
          echo "$TELEGRAM_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "status=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "workflow=$WORKFLOW_NAME" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        if: env.GH_NOTIFY_TELEGRAM_BOT_TOKEN != '' && env.GH_NOTIFY_TELEGRAM_CHAT_ID != ''
        run: |
          # Send message to Telegram bot
          # Create JSON payload with proper escaping
          JSON_PAYLOAD=$(cat <<EOF
          {
            "chat_id": "${{ secrets.GH_NOTIFY_TELEGRAM_CHAT_ID }}",
            "text": "${{ steps.notification.outputs.telegram_message }}",
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }
          EOF
          )

          curl -X POST "https://api.telegram.org/bot${{ secrets.GH_NOTIFY_TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$JSON_PAYLOAD"

      - name: Log failure details
        if: github.event.workflow_run.conclusion == 'failure'
        run: |
          echo "Workflow failed: ${{ github.event.workflow_run.name }}"
          echo "See: https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

  # Daily status report
  daily-report:
    name: 'Daily Status Report'
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 8 * * *'
    steps:
      - name: Generate daily report
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–ø—É—Å–∫–æ–≤ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
          echo "## üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "**–î–∞—Ç–∞:** $(date -u '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç - –≤ production –≤—ã –±—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ GitHub API
          echo "### üîÑ –ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤" >> $GITHUB_STEP_SUMMARY
          echo "- **–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞:** –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏ –≤–æ –≤–∫–ª–∞–¥–∫–µ Actions" >> $GITHUB_STEP_SUMMARY
          echo "- **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** CodeQL, SAST, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤" >> $GITHUB_STEP_SUMMARY
          echo "- **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:** Dependabot PRs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üìà –ú–µ—Ç—Ä–∏–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è" >> $GITHUB_STEP_SUMMARY
          echo "- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏:** –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Actions" >> $GITHUB_STEP_SUMMARY
          echo "- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:** –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã codecov" >> $GITHUB_STEP_SUMMARY
          echo "- **–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫—É Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" >> $GITHUB_STEP_SUMMARY
          echo "- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã" >> $GITHUB_STEP_SUMMARY
          echo "- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" >> $GITHUB_STEP_SUMMARY
          echo "- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PRs –æ—Ç Dependabot" >> $GITHUB_STEP_SUMMARY

      - name: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Telegram
        if: env.GH_NOTIFY_TELEGRAM_BOT_TOKEN != '' && env.GH_NOTIFY_TELEGRAM_CHAT_ID != ''
        run: |
          # –°–æ–∑–¥–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          REPO_NAME="${{ github.repository }}"
          ESCAPED_REPO=$(echo "$REPO_NAME" | sed 's/[_*[\]()~`>#+-=|{}.!]/\\&/g')

          # –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
          REPORT_LINE1="üìä *–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç CI/CD*"
          REPORT_LINE2="üìÖ $(date -u '+%Y-%m-%d')"
          REPORT_LINE3=""
          REPORT_LINE4="*–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:* $ESCAPED_REPO"
          REPORT_LINE5=""
          REPORT_LINE6="üîÑ *–ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:*"
          REPORT_LINE7="‚Ä¢ –û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫—É Actions"
          REPORT_LINE8="‚Ä¢ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: CodeQL, SAST, Container"
          REPORT_LINE9="‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: Dependabot PRs"
          REPORT_LINE10=""
          REPORT_LINE11="üìà *–ú–µ—Ç—Ä–∏–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è:*"
          REPORT_LINE12="‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏: –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Actions"
          REPORT_LINE13="‚Ä¢ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã Codecov"
          REPORT_LINE14="‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫—É Security"
          REPORT_LINE15=""
          REPORT_LINE16="üéØ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*"
          REPORT_LINE17="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã"
          REPORT_LINE18="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
          REPORT_LINE19="‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PRs –æ—Ç Dependabot"
          REPORT_LINE20=""
          REPORT_LINE21="üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Combine into final report message using printf
          REPORT_MESSAGE=$(printf '%s\n%s\n\n%s\n\n%s\n%s\n%s\n%s\n\n%s\n%s\n%s\n%s\n\n%s\n%s\n%s\n%s\n\n%s' \
            "$REPORT_LINE1" \
            "$REPORT_LINE2" \
            "$REPORT_LINE4" \
            "$REPORT_LINE6" \
            "$REPORT_LINE7" \
            "$REPORT_LINE8" \
            "$REPORT_LINE9" \
            "$REPORT_LINE11" \
            "$REPORT_LINE12" \
            "$REPORT_LINE13" \
            "$REPORT_LINE14" \
            "$REPORT_LINE16" \
            "$REPORT_LINE17" \
            "$REPORT_LINE18" \
            "$REPORT_LINE19" \
            "$REPORT_LINE21")

          # Send to Telegram
          curl -X POST "https://api.telegram.org/bot${{ secrets.GH_NOTIFY_TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${{ secrets.GH_NOTIFY_TELEGRAM_CHAT_ID }}\",
              \"text\": \"$REPORT_MESSAGE\",
              \"parse_mode\": \"MarkdownV2\",
              \"disable_web_page_preview\": true
            }"
